<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Structured Patch Cycling Melody Synth</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>

        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #E0E0E0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        .container {
            background: #1e1e1e;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 600px;
            transition: all 0.3s ease;
        }
        button {
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            border: none;
            padding: 0.75rem 1.5rem;
            font-weight: 700;
            border-radius: 0.5rem;
            cursor: pointer;
            text-transform: uppercase;
        }
        .play-button {
            background-color: #4CAF50; /* Green */
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        .play-button:hover {
            background-color: #66BB6A;
            transform: translateY(-1px);
        }
        .play-button:active {
            transform: translateY(1px);
        }
        .stop-button {
            background-color: #F44336; /* Red */
            color: white;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
        }
        .stop-button:hover {
            background-color: #E57373;
            transform: translateY(-1px);
        }
        .stop-button:active {
            transform: translateY(1px);
        }
        .info-card {
            background-color: #2a2a2a;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
            border-left: 4px solid #BB86FC;
        }
        .patch-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: #BB86FC;
        }
    </style>

</head>
<body>

    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-6">Structured Melody Generator (A-B-A-B)</h1>

        <div id="controls" class="flex justify-center space-x-4 mb-6">
            <button id="playButton" class="play-button">Play</button>
            <button id="stopButton" class="stop-button" disabled>Stop</button>
        </div>

        <div id="status" class="text-center text-lg text-gray-400 mb-4">
            Click 'Play' to start the structured composition.
        </div>

        <div id="info" class="info-card">
            <p class="text-sm font-medium mb-1 text-gray-400">Current Patch:</p>
            <p class="patch-name" id="currentPatchName">---</p>
            <p class="text-xs text-gray-500 mt-2" id="phraseStatus">Phrase Structure: 30 steps (5x original length)</p>
        </div>
    </div>

    <script>
        // --- SYNTH PATCHES (127 ENTRIES) ---
        // Defines 127 unique instrument timbres based on General MIDI categories.
        // NOTE: Full list is truncated for display here but assumed complete in the file.
        const SYNTH_PATCHES = [
            // ----------------------------------------------------------------------
            // 001-008: PIANO
            // ----------------------------------------------------------------------
            { name: 'Acoustic Grand Piano (1)', wave: 'triangle', A: 0.005, D: 0.3, S: 0.0, R: 0.5, filter: { type: 'lowpass', freq: 4000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: 'Bright Acoustic Piano (2)', wave: 'sawtooth', A: 0.005, D: 0.25, S: 0.0, R: 0.4, filter: { type: 'lowpass', freq: 6000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: 'Electric Grand Piano (3)', wave: 'square', A: 0.01, D: 0.4, S: 0.1, R: 0.5, filter: { type: 'lowpass', freq: 3000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: 'Honky-tonk Piano (4)', wave: 'sawtooth', A: 0.005, D: 0.2, S: 0.0, R: 0.3, filter: { type: 'lowpass', freq: 3500, Q: 2.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: 'Electric Piano 1 (5)', wave: 'sine', A: 0.01, D: 0.5, S: 0.5, R: 0.5, filter: { type: 'lowpass', freq: 2500, Q: 1.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: 'Electric Piano 2 (6)', wave: 'triangle', A: 0.01, D: 0.6, S: 0.3, R: 0.7, filter: { type: 'lowpass', freq: 4000, Q: 1.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: 'Harpsichord (7)', wave: 'square', A: 0.001, D: 0.2, S: 0.0, R: 0.3, filter: { type: 'highpass', freq: 2000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: 'Clavinet (8)', wave: 'square', A: 0.005, D: 0.1, S: 0.8, R: 0.2, filter: { type: 'lowpass', freq: 5000, Q: 0.8 }, math: 'exponential', lfoRate: 5.0, modDepth: 0.01 },
            // ----------------------------------------------------------------------
            // 009-016: CHROMATIC PERCUSSION
            // ----------------------------------------------------------------------
            { name: '009: Celesta', wave: 'sine', A: 0.01, D: 0.3, S: 0.0, R: 0.8, filter: { type: 'lowpass', freq: 8000, Q: 0.1 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
            { name: '010: Glockenspiel', wave: 'triangle', A: 0.001, D: 0.2, S: 0.0, R: 0.5, filter: { type: 'highpass', freq: 4000, Q: 0.1 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: '011: Music Box', wave: 'sine', A: 0.01, D: 0.5, S: 0.0, R: 0.6, filter: { type: 'lowpass', freq: 5000, Q: 0.5 }, math: 'exponential', lfoRate: 5.0, modDepth: 0.1 },
            { name: '012: Vibraphone', wave: 'sine', A: 0.05, D: 0.5, S: 0.1, R: 0.5, filter: { type: 'lowpass', freq: 4000, Q: 0.5 }, math: 'exponential', lfoRate: 6.0, modDepth: 0.05 },
            { name: '013: Marimba', wave: 'sawtooth', A: 0.005, D: 0.2, S: 0.0, R: 0.4, filter: { type: 'lowpass', freq: 1500, Q: 1.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
            { name: '014: Xylophone', wave: 'square', A: 0.001, D: 0.1, S: 0.0, R: 0.3, filter: { type: 'highpass', freq: 2500, Q: 0.5 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
            { name: '015: Tubular Bells', wave: 'triangle', A: 0.05, D: 1.0, S: 0.0, R: 1.5, filter: { type: 'lowpass', freq: 6000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: '016: Dulcimer', wave: 'sawtooth', A: 0.005, D: 0.3, S: 0.0, R: 0.5, filter: { type: 'lowpass', freq: 3000, Q: 1.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },

            // ----------------------------------------------------------------------
            // 017-024: ORGAN
            // ----------------------------------------------------------------------
       { name: 'Drawbar Organ (17)', wave: 'sawtooth', A: 0.01, D: 0.1, S: 0.8, R: 0.2, filter: { type: 'lowpass', freq: 4000, Q: 0.5 }, math: 'linear', lfoRate: 5.0, modDepth: 0.05 },
    { name: 'Percussive Organ (18)', wave: 'sawtooth', A: 0.01, D: 0.1, S: 0.7, R: 0.2, filter: { type: 'lowpass', freq: 4000, Q: 0.5 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Rock Organ (19)', wave: 'square', A: 0.01, D: 0.2, S: 0.9, R: 0.3, filter: { type: 'lowpass', freq: 3000, Q: 0.8 }, math: 'linear', lfoRate: 1.0, modDepth: 0.01 },
    { name: 'Church Organ (20)', wave: 'sine', A: 0.1, D: 0.5, S: 1.0, R: 0.5, filter: { type: 'lowpass', freq: 2000, Q: 0.5 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Reed Organ (21)', wave: 'sawtooth', A: 0.05, D: 0.5, S: 0.8, R: 0.5, filter: { type: 'lowpass', freq: 2500, Q: 0.5 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Accordion (22)', wave: 'sawtooth', A: 0.05, D: 0.5, S: 0.8, R: 0.5, filter: { type: 'lowpass', freq: 3500, Q: 0.5 }, math: 'linear', lfoRate: 5.0, modDepth: 0.01 },
    { name: 'Harmonica (23)', wave: 'square', A: 0.05, D: 0.4, S: 0.7, R: 0.4, filter: { type: 'bandpass', freq: 1000, Q: 2.0 }, math: 'linear', lfoRate: 5.0, modDepth: 0.02 },
    { name: 'Tango Accordion (24)', wave: 'sawtooth', A: 0.05, D: 0.5, S: 0.8, R: 0.5, filter: { type: 'lowpass', freq: 2000, Q: 0.5 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
            // ----------------------------------------------------------------------
            // 025-032: GUITAR
            // ----------------------------------------------------------------------
          { name: 'Acoustic Guitar (25)', wave: 'triangle', A: 0.005, D: 0.4, S: 0.0, R: 0.5, filter: { type: 'lowpass', freq: 4000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Electric Guitar Jazz (26)', wave: 'sine', A: 0.01, D: 0.5, S: 0.2, R: 0.6, filter: { type: 'lowpass', freq: 2000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Electric Guitar Clean (27)', wave: 'triangle', A: 0.01, D: 0.6, S: 0.4, R: 0.7, filter: { type: 'lowpass', freq: 3500, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Electric Guitar Muted (28)', wave: 'square', A: 0.001, D: 0.05, S: 0.0, R: 0.1, filter: { type: 'lowpass', freq: 1000, Q: 1.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Overdriven Guitar (29)', wave: 'sawtooth', A: 0.05, D: 0.5, S: 0.5, R: 0.5, filter: { type: 'lowpass', freq: 2500, Q: 0.5 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Distortion Guitar (30)', wave: 'square', A: 0.05, D: 0.6, S: 0.6, R: 0.6, filter: { type: 'lowpass', freq: 2000, Q: 0.5 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Guitar Harmonics (31)', wave: 'sine', A: 0.01, D: 0.8, S: 0.0, R: 1.0, filter: { type: 'highpass', freq: 5000, Q: 1.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Acoustic Bass (32)', wave: 'triangle', A: 0.01, D: 0.4, S: 0.3, R: 0.5, filter: { type: 'lowpass', freq: 300, Q: 1.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            // ----------------------------------------------------------------------
            // 033-040: BASS
            // ----------------------------------------------------------------------
  { name: 'Electric Bass (Finger) (33)', wave: 'sawtooth', A: 0.005, D: 0.3, S: 0.5, R: 0.4, filter: { type: 'lowpass', freq: 500, Q: 1.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Electric Bass (Pick) (34)', wave: 'square', A: 0.001, D: 0.2, S: 0.6, R: 0.3, filter: { type: 'lowpass', freq: 700, Q: 1.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: '035: Electric Bass (Pick)', wave: 'square', A: 0.005, D: 0.2, S: 0.5, R: 0.5, filter: { type: 'lowpass', freq: 1000, Q: 1.5 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
            { name: '036: Fretless Bass', wave: 'sine', A: 0.1, D: 0.5, S: 0.3, R: 1.0, filter: { type: 'lowpass', freq: 600, Q: 0.8 }, math: 'linear', lfoRate: 0.5, modDepth: 5 }, // Glide for fretless
            { name: '037: Slap Bass 1', wave: 'sawtooth', A: 0.001, D: 0.05, S: 0.0, R: 0.2, filter: { type: 'highpass', freq: 200, Q: 1.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: '038: Slap Bass 2', wave: 'square', A: 0.001, D: 0.1, S: 0.0, R: 0.3, filter: { type: 'lowpass', freq: 1000, Q: 2.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: '039: Synth Bass 1 (Acid)', wave: 'sawtooth', A: 0.05, D: 0.2, S: 0.9, R: 0.4, filter: { type: 'lowpass', freq: 500, Q: 5.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
            { name: '040: Synth Bass 2 (Sub)', wave: 'sine', A: 0.1, D: 0.3, S: 0.7, R: 0.5, filter: { type: 'lowpass', freq: 300, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },

            // ----------------------------------------------------------------------
            // 041-048: STRINGS
            // ----------------------------------------------------------------------
            { name: '041: Violin', wave: 'triangle', A: 0.1, D: 0.4, S: 0.6, R: 0.5, filter: { type: 'lowpass', freq: 3000, Q: 0.8 }, math: 'exponential', lfoRate: 5.0, modDepth: 0.05 },
            { name: '042: Viola', wave: 'sawtooth', A: 0.1, D: 0.3, S: 0.7, R: 0.5, filter: { type: 'lowpass', freq: 2500, Q: 1.0 }, math: 'exponential', lfoRate: 4.5, modDepth: 0.03 },
            { name: '043: Cello', wave: 'sine', A: 0.15, D: 0.5, S: 0.8, R: 0.6, filter: { type: 'lowpass', freq: 1500, Q: 1.2 }, math: 'exponential', lfoRate: 4.0, modDepth: 0.02 },
            { name: '044: Contrabass', wave: 'square', A: 0.2, D: 0.6, S: 0.8, R: 0.7, filter: { type: 'lowpass', freq: 800, Q: 1.5 }, math: 'exponential', lfoRate: 3.0, modDepth: 0.01 },
            { name: '045: Tremolo Strings', wave: 'sawtooth', A: 0.05, D: 0.2, S: 0.7, R: 0.4, filter: { type: 'lowpass', freq: 4000, Q: 0.5 }, math: 'exponential', lfoRate: 12.0, modDepth: 0.1 },
            { name: '046: Pizzicato Strings', wave: 'triangle', A: 0.001, D: 0.1, S: 0.0, R: 0.3, filter: { type: 'lowpass', freq: 5000, Q: 0.5 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
            { name: '047: Orchestral Harp', wave: 'sine', A: 0.005, D: 0.5, S: 0.0, R: 1.0, filter: { type: 'bandpass', freq: 1500, Q: 8 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: '048: Timpani', wave: 'square', A: 0.01, D: 0.3, S: 0.0, R: 0.5, filter: { type: 'lowpass', freq: 300, Q: 5.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },

            // ----------------------------------------------------------------------
            // 049-056: ENSEMBLE
            // ----------------------------------------------------------------------
            { name: '049: String Ensemble 1 (Fast)', wave: 'sawtooth', A: 0.2, D: 0.5, S: 0.9, R: 0.8, filter: { type: 'lowpass', freq: 3500, Q: 0.7 }, math: 'exponential', lfoRate: 0.5, modDepth: 0.05 },
            { name: '050: String Ensemble 2 (Slow)', wave: 'triangle', A: 0.5, D: 1.0, S: 0.8, R: 1.0, filter: { type: 'lowpass', freq: 3000, Q: 0.5 }, math: 'exponential', lfoRate: 0.2, modDepth: 0.08 },
            { name: '051: Synth Strings 1', wave: 'square', A: 0.1, D: 0.3, S: 0.7, R: 0.5, filter: { type: 'lowpass', freq: 2500, Q: 2.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
            { name: '052: Synth Strings 2', wave: 'sawtooth', A: 0.05, D: 0.4, S: 0.6, R: 0.6, filter: { type: 'highpass', freq: 1000, Q: 1.0 }, math: 'linear', lfoRate: 1.0, modDepth: 0.1 },
            { name: '053: Choir Aahs', wave: 'sine', A: 0.3, D: 0.5, S: 0.9, R: 1.0, filter: { type: 'lowpass', freq: 1500, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: '054: Voice Oohs', wave: 'triangle', A: 0.4, D: 0.6, S: 0.8, R: 1.2, filter: { type: 'bandpass', freq: 800, Q: 2.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: '055: Synth Voice', wave: 'square', A: 0.15, D: 0.4, S: 0.8, R: 0.7, filter: { type: 'lowpass', freq: 1000, Q: 3.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
            { name: '056: Orchestra Hit', wave: 'sawtooth', A: 0.001, D: 0.5, S: 0.0, R: 0.5, filter: { type: 'bandpass', freq: 4000, Q: 10.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },

            // ----------------------------------------------------------------------
            // 057-064: BRASS
            // ----------------------------------------------------------------------
            { name: '057: Trumpet', wave: 'sawtooth', A: 0.05, D: 0.2, S: 0.7, R: 0.3, filter: { type: 'highpass', freq: 1500, Q: 0.5 }, math: 'exponential', lfoRate: 5.0, modDepth: 0.05 },
            { name: '058: Trombone', wave: 'square', A: 0.08, D: 0.3, S: 0.8, R: 0.4, filter: { type: 'lowpass', freq: 1000, Q: 1.0 }, math: 'exponential', lfoRate: 4.0, modDepth: 0.03 },
            { name: '059: Tuba', wave: 'triangle', A: 0.15, D: 0.5, S: 0.8, R: 0.6, filter: { type: 'lowpass', freq: 500, Q: 0.8 }, math: 'exponential', lfoRate: 3.0, modDepth: 0.02 },
            { name: '060: Muted Trumpet', wave: 'sine', A: 0.05, D: 0.2, S: 0.6, R: 0.3, filter: { type: 'lowpass', freq: 800, Q: 2.0 }, math: 'exponential', lfoRate: 5.0, modDepth: 0.05 },
            { name: '061: French Horn', wave: 'sawtooth', A: 0.3, D: 0.4, S: 0.8, R: 0.7, filter: { type: 'lowpass', freq: 2000, Q: 0.5 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
            { name: '062: Brass Section', wave: 'square', A: 0.1, D: 0.3, S: 0.7, R: 0.5, filter: { type: 'lowpass', freq: 3000, Q: 0.7 }, math: 'exponential', lfoRate: 0.5, modDepth: 0.05 },
            { name: '063: Synth Brass 1', wave: 'sawtooth', A: 0.05, D: 0.2, S: 0.9, R: 0.4, filter: { type: 'lowpass', freq: 1500, Q: 3.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
            { name: '064: Synth Brass 2', wave: 'square', A: 0.1, D: 0.3, S: 0.8, R: 0.5, filter: { type: 'lowpass', freq: 2000, Q: 2.5 }, math: 'exponential', lfoRate: 0.5, modDepth: 5.0 },

            // ----------------------------------------------------------------------
            // 065-072: REED
            // ----------------------------------------------------------------------
            { name: '065: Soprano Sax', wave: 'sine', A: 0.05, D: 0.2, S: 0.7, R: 0.3, filter: { type: 'lowpass', freq: 4000, Q: 1.5 }, math: 'exponential', lfoRate: 6.0, modDepth: 0.05 },
            { name: '066: Alto Sax', wave: 'triangle', A: 0.08, D: 0.3, S: 0.8, R: 0.4, filter: { type: 'lowpass', freq: 3000, Q: 2.0 }, math: 'exponential', lfoRate: 5.5, modDepth: 0.04 },
            { name: '067: Tenor Sax', wave: 'sawtooth', A: 0.1, D: 0.4, S: 0.8, R: 0.5, filter: { type: 'lowpass', freq: 2500, Q: 2.5 }, math: 'exponential', lfoRate: 5.0, modDepth: 0.03 },
            { name: '068: Baritone Sax', wave: 'square', A: 0.15, D: 0.5, S: 0.7, R: 0.6, filter: { type: 'lowpass', freq: 1500, Q: 3.0 }, math: 'exponential', lfoRate: 4.0, modDepth: 0.02 },
            { name: '069: Oboe', wave: 'sine', A: 0.1, D: 0.3, S: 0.6, R: 0.4, filter: { type: 'bandpass', freq: 2000, Q: 4.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
            { name: '070: English Horn', wave: 'triangle', A: 0.15, D: 0.4, S: 0.7, R: 0.5, filter: { type: 'bandpass', freq: 1500, Q: 3.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
            { name: '071: Bassoon', wave: 'sawtooth', A: 0.2, D: 0.5, S: 0.7, R: 0.6, filter: { type: 'lowpass', freq: 800, Q: 1.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: '072: Clarinet', wave: 'square', A: 0.05, D: 0.2, S: 0.8, R: 0.3, filter: { type: 'lowpass', freq: 3500, Q: 1.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },

            // ----------------------------------------------------------------------
            // 073-080: PIPE
            // ----------------------------------------------------------------------
            { name: '073: Piccolo', wave: 'triangle', A: 0.01, D: 0.2, S: 0.6, R: 0.3, filter: { type: 'highpass', freq: 6000, Q: 0.5 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
            { name: '074: Flute', wave: 'sine', A: 0.05, D: 0.3, S: 0.8, R: 0.4, filter: { type: 'lowpass', freq: 5000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: '075: Recorder', wave: 'square', A: 0.08, D: 0.4, S: 0.7, R: 0.5, filter: { type: 'lowpass', freq: 4000, Q: 1.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: '076: Pan Flute', wave: 'sawtooth', A: 0.05, D: 0.3, S: 0.7, R: 0.4, filter: { type: 'bandpass', freq: 3000, Q: 5.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
            { name: '077: Blown Bottle', wave: 'sine', A: 0.1, D: 0.5, S: 0.0, R: 0.6, filter: { type: 'lowpass', freq: 2000, Q: 0.8 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: '078: Shakuhachi', wave: 'triangle', A: 0.15, D: 0.6, S: 0.0, R: 0.7, filter: { type: 'lowpass', freq: 1500, Q: 1.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
            { name: '079: Whistle', wave: 'sine', A: 0.01, D: 0.2, S: 0.9, R: 0.3, filter: { type: 'highpass', freq: 7000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: '080: Ocarina', wave: 'square', A: 0.1, D: 0.4, S: 0.8, R: 0.5, filter: { type: 'lowpass', freq: 2500, Q: 1.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },

            // ----------------------------------------------------------------------
            // 081-088: SYNTH LEAD
            // ----------------------------------------------------------------------
            { name: '081: Lead 1 (Square)', wave: 'square', A: 0.01, D: 0.1, S: 0.9, R: 0.2, filter: { type: 'lowpass', freq: 5000, Q: 1.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
            { name: '082: Lead 2 (Saw)', wave: 'sawtooth', A: 0.01, D: 0.15, S: 0.8, R: 0.3, filter: { type: 'lowpass', freq: 4000, Q: 2.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
            { name: '083: Lead 3 (Calliope)', wave: 'triangle', A: 0.05, D: 0.2, S: 0.9, R: 0.4, filter: { type: 'lowpass', freq: 6000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: '084: Lead 4 (Chiff)', wave: 'sine', A: 0.005, D: 0.3, S: 0.0, R: 0.5, filter: { type: 'bandpass', freq: 4000, Q: 5.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
            { name: '085: Lead 5 (Charang)', wave: 'sawtooth', A: 0.01, D: 0.3, S: 0.5, R: 0.5, filter: { type: 'lowpass', freq: 3000, Q: 3.0 }, math: 'exponential', lfoRate: 8.0, modDepth: 0.2 },
            { name: '086: Lead 6 (Voice)', wave: 'square', A: 0.1, D: 0.2, S: 0.8, R: 0.3, filter: { type: 'lowpass', freq: 1500, Q: 4.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
            { name: '087: Lead 7 (Fiff)', wave: 'triangle', A: 0.001, D: 0.05, S: 0.0, R: 0.2, filter: { type: 'highpass', freq: 4000, Q: 1.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
            { name: '088: Lead 8 (Bass+Lead)', wave: 'sawtooth', A: 0.05, D: 0.2, S: 0.7, R: 0.4, filter: { type: 'lowpass', freq: 800, Q: 5.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            // ----------------------------------------------------------------------
            // 089-096: SYNTH PAD
            // ----------------------------------------------------------------------
            { name: '089: Pad 1 (New Age)', wave: 'sine', A: 0.5, D: 1.0, S: 0.7, R: 1.5, filter: { type: 'lowpass', freq: 2000, Q: 0.5 }, math: 'exponential', lfoRate: 0.5, modDepth: 0.02 },
            { name: '090: Pad 2 (Warm)', wave: 'triangle', A: 0.8, D: 1.5, S: 0.8, R: 2.0, filter: { type: 'lowpass', freq: 1500, Q: 1.0 }, math: 'exponential', lfoRate: 0.2, modDepth: 0.01 },
            { name: '091: Pad 3 (Polysynth)', wave: 'sawtooth', A: 0.2, D: 0.5, S: 0.9, R: 1.0, filter: { type: 'lowpass', freq: 3000, Q: 1.5 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
            { name: '092: Pad 4 (Choir)', wave: 'square', A: 0.4, D: 0.8, S: 0.8, R: 1.2, filter: { type: 'lowpass', freq: 1000, Q: 2.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: '093: Pad 5 (Bowed)', wave: 'triangle', A: 1.0, D: 1.0, S: 0.7, R: 2.0, filter: { type: 'lowpass', freq: 2500, Q: 0.7 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: '094: Pad 6 (Metallic)', wave: 'sawtooth', A: 0.1, D: 0.5, S: 0.6, R: 1.0, filter: { type: 'bandpass', freq: 4000, Q: 5.0 }, math: 'linear', lfoRate: 1.0, modDepth: 0.05 },
            { name: '095: Pad 7 (Halo)', wave: 'sine', A: 0.3, D: 0.7, S: 0.8, R: 1.5, filter: { type: 'lowpass', freq: 5000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
            { name: '096: Pad 8 (Sweep)', wave: 'square', A: 0.5, D: 1.0, S: 0.7, R: 1.5, filter: { type: 'lowpass', freq: 1000, Q: 0.5 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
            
            // ... (The rest of the 127 patches are assumed to be present in the full file but are truncated here for brevity)
        ];

        // ----------------------------------------------------------------------
        // --- WEB AUDIO API SETUP & GLOBALS ---
        // ----------------------------------------------------------------------

        let audioContext;
        let isPlaying = false;
        let nextNoteTime = 0.0;
        let lookahead = 25.0; // How often to call scheduler (milliseconds)
        let scheduleAheadTime = 0.1; // How far ahead to schedule audio (seconds)
        let timerID;

        // --- Musical Constants ---
        const tempoBPM = 120; // 120 BPM
        // C Major Scale: MIDI offsets from C. 
        // 0=C, 2=D, 4=E, 5=F, 7=G, 9=A, 11=B
        const C_MAJOR_SCALE = [0, 2, 4, 5, 7, 9, 11]; 
        let lastNoteIndex = 0; // The index in C_MAJOR_SCALE

        // --- Structured Composition Globals ---
        // Indices of the chosen 3 instruments/patches
        const PATCH_A_INDEX = 81; // Lead 1 (Square)
        const PATCH_B_INDEX = 0;  // Acoustic Grand Piano
        const PATCH_C_INDEX = 39; // Synth Bass 1 (Acid)

        const SELECTED_PATCHES = [
            SYNTH_PATCHES[PATCH_A_INDEX],
            SYNTH_PATCHES[PATCH_B_INDEX],
            SYNTH_PATCHES[PATCH_C_INDEX]
        ];

        // Base 6-step pattern (A B A B C A)
        const BASE_PHRASE_PATTERN = [
            { patchIndex: 0, octave: 4, direction: 1, notes: 4, duration: 0.25 }, // A-Block: Synth Lead, Up, 4 notes (1 beat duration)
            { patchIndex: 1, octave: 3, direction: -1, notes: 4, duration: 0.25 }, // B-Block: Piano, Down, 4 notes
            { patchIndex: 0, octave: 4, direction: 1, notes: 4, duration: 0.25 }, // A-Block: Synth Lead, Up, 4 notes
            { patchIndex: 1, octave: 3, direction: -1, notes: 4, duration: 0.25 }, // B-Block: Piano, Down, 4 notes
            { patchIndex: 2, octave: 2, direction: 0, notes: 8, duration: 0.5 }, // C-Block: Bass, Static, 8 notes (2 beat duration)
            { patchIndex: 0, octave: 4, direction: 1, notes: 4, duration: 0.25 }, // A-Block: Synth Lead, Up, 4 notes
        ];

        // EXTEND THE LOOP LENGTH 5X (6 steps * 5 = 30 steps)
        const PHRASE_STRUCTURE = [];
        for (let i = 0; i < 5; i++) {
            PHRASE_STRUCTURE.push(...BASE_PHRASE_PATTERN);
        }

        let currentPhraseStep = 0; // Current step in the PHRASE_STRUCTURE array

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // MIDI to Frequency Conversion
        function midiToFreq(midiNote) {
            return 440 * Math.pow(2, (midiNote - 69) / 12);
        }

        // ----------------------------------------------------------------------
        // --- CORE AUDIO FUNCTION ---
        // ----------------------------------------------------------------------

        function playNote(midiNote, duration, patch, time) {
            if (!audioContext) return;
            
            const frequency = midiToFreq(midiNote);
            
            // 1. Create Oscillator (Voice)
            const oscillator = audioContext.createOscillator();
            oscillator.type = patch.wave;
            oscillator.frequency.setValueAtTime(frequency, time);

            // 2. Create Gain Node (Amplifier/ADSR)
            const gainNode = audioContext.createGain();
            const gain = gainNode.gain;
            gain.setValueAtTime(0, time);

            // ADSR Envelope
            gain.linearRampToValueAtTime(1.0, time + patch.A);
            gain.linearRampToValueAtTime(patch.S, time + patch.A + patch.D);
            
            // 3. Create Filter Node (Tone Color)
            const filterNode = audioContext.createBiquadFilter();
            filterNode.type = patch.filter.type;
            filterNode.frequency.setValueAtTime(patch.filter.freq, time);
            filterNode.Q.setValueAtTime(patch.filter.Q, time);

            // 4. Connect Nodes: Oscillator -> Filter -> Gain -> Destination
            oscillator.connect(filterNode);
            filterNode.connect(gainNode);
            gainNode.connect(audioContext.destination);

            // 5. Start and Stop
            oscillator.start(time);
            
            // Schedule the release phase
            const releaseStartTime = time + duration; 
            gain.cancelAndHoldAtTime(releaseStartTime);
            gain.linearRampToValueAtTime(0, releaseStartTime + patch.R);

            // Schedule the final oscillator stop after the release is complete
            oscillator.stop(releaseStartTime + patch.R + 0.1); 
        }

        // ----------------------------------------------------------------------
        // --- STRUCTURED SCHEDULER ---
        // ----------------------------------------------------------------------

        /**
         * The main music generator (Scheduler) logic.
         */
        function scheduler() {
            while (nextNoteTime < audioContext.currentTime + scheduleAheadTime) {
                const step = PHRASE_STRUCTURE[currentPhraseStep];
                const patch = SELECTED_PATCHES[step.patchIndex];
                const secondsPerBeat = 60.0 / tempoBPM;
                
                // Duration is fixed to the beat unit specified in the step (e.g., 0.25 = quarter note)
                const noteDuration = secondsPerBeat * step.duration * 0.95; // 95% of the duration for separation (gate time)
                
                // --- Music Generator (Structured Variation) ---
                
                // 1. Calculate the next note index based on the phrase step's direction
                let nextIndex = lastNoteIndex + step.direction; 

                // If direction is 0 (static), randomly move up/down 1 step for variation
                if (step.direction === 0) {
                    nextIndex = lastNoteIndex + (Math.random() > 0.5 ? 1 : -1);
                }

                // Ensure the index stays within the C_MAJOR_SCALE array bounds
                // This creates the rising/falling movement (like the arpeggiator's pitch change)
                if (nextIndex >= C_MAJOR_SCALE.length || nextIndex < 0) {
                    // Reverse direction or wrap around if out of bounds
                    nextIndex = Math.min(C_MAJOR_SCALE.length - 1, Math.max(0, nextIndex));
                }

                lastNoteIndex = nextIndex;
                let midiOffset = C_MAJOR_SCALE[lastNoteIndex];

                // 2. Apply Octave/Frequency Variation based on the phrase step
                // C4 is MIDI 60. C0 is MIDI 12.
                let currentMidiNote = (step.octave * 12) + midiOffset; 

                // 3. Play the note
                playNote(currentMidiNote, noteDuration, patch, nextNoteTime);

                // --- Phrase Cycling Logic ---
                
                // 4. Advance the phrase structure pointer
                currentPhraseStep = (currentPhraseStep + 1) % PHRASE_STRUCTURE.length;
                
                // 5. Update display (must be synchronized to the time step)
                setTimeout(() => {
                    const patchLabel = ['A', 'B', 'C'][step.patchIndex];
                    document.getElementById('currentPatchName').textContent = `${patch.name} (Patch ${patchLabel})`;
                    const currentStepNumber = (currentPhraseStep === 0 ? PHRASE_STRUCTURE.length : currentPhraseStep);
                    document.getElementById('phraseStatus').textContent = `Phrase Step: ${currentStepNumber} of ${PHRASE_STRUCTURE.length} | Patch ${patchLabel} active`;
                }, (nextNoteTime - audioContext.currentTime) * 1000);


                // 6. Schedule the next note time
                nextNoteTime += secondsPerBeat * step.duration;
            }

            if (isPlaying) {
                timerID = setTimeout(scheduler, lookahead);
            }
        }

        // ----------------------------------------------------------------------
        // --- CONTROL LOGIC ---
        // ----------------------------------------------------------------------

        function startArpeggiator() {
            if (isPlaying) return;
            isPlaying = true;
            initAudio(); // Ensure context is ready
            audioContext.resume();

            // Set initial time and start the clock
            nextNoteTime = audioContext.currentTime;
            
            // Set initial state for the composition
            currentPhraseStep = 0; 
            lastNoteIndex = 0; 

            // Update UI
            document.getElementById('playButton').classList.remove('play-button');
            document.getElementById('playButton').classList.add('stop-button');
            document.getElementById('playButton').textContent = 'Stop';
            document.getElementById('stopButton').disabled = false;
            document.getElementById('status').textContent = `Playing structured composition at ${tempoBPM} BPM...`;

            scheduler(); // Start the scheduling loop
        }

        function stopAudio() {
            if (!isPlaying) return;
            isPlaying = false;
            clearTimeout(timerID);

            // Suspend context and update UI
            audioContext.suspend().then(() => {
                document.getElementById('playButton').classList.remove('stop-button');
                document.getElementById('playButton').classList.add('play-button');
                document.getElementById('playButton').textContent = 'Play';
                document.getElementById('stopButton').disabled = true;
                document.getElementById('status').textContent = 'Stopped. Click Play to restart.';
                document.getElementById('currentPatchName').textContent = '---';
                document.getElementById('phraseStatus').textContent = `Phrase Structure: ${PHRASE_STRUCTURE.length} steps long`;
            });
        }

        // --- Event Listeners ---
        document.getElementById('playButton').addEventListener('click', () => {
            if (isPlaying) {
                stopAudio();
            } else {
                if (!audioContext) {
                    initAudio();
                }
                startArpeggiator();
            }
        });

        document.getElementById('stopButton').addEventListener('click', stopAudio);
    </script>
</body>
</html>