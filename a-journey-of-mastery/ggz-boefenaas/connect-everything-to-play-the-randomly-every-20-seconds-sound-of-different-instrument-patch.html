

<button id="playButton" style='width:104%;height:104%;z-index:10000000;background-color:transparent;position:fixed;left:-2%;top:-2%'> </button>
    <div id="info"> </div>

    <script>



const SYNTH_PATCHES = [
    // ----------------------------------------------------------------------
    // 01-08: PIANO
    // ----------------------------------------------------------------------
    { name: 'Acoustic Grand Piano (1)', wave: 'triangle', A: 0.005, D: 0.3, S: 0.0, R: 0.5, filter: { type: 'lowpass', freq: 4000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Bright Acoustic Piano (2)', wave: 'sawtooth', A: 0.005, D: 0.25, S: 0.0, R: 0.4, filter: { type: 'lowpass', freq: 6000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Electric Grand Piano (3)', wave: 'square', A: 0.01, D: 0.4, S: 0.1, R: 0.5, filter: { type: 'lowpass', freq: 3000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Honky-tonk Piano (4)', wave: 'triangle', A: 0.01, D: 0.3, S: 0.0, R: 0.5, filter: { type: 'bandpass', freq: 1500, Q: 1.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Electric Piano 1 (5)', wave: 'sine', A: 0.05, D: 0.5, S: 0.4, R: 1.0, filter: { type: 'lowpass', freq: 1500, Q: 1.5 }, math: 'exponential', lfoRate: 5.0, modDepth: 0.5, multiOsc: true }, // Tremolo/Phaser-effect
    { name: 'Electric Piano 2 (6)', wave: 'sawtooth', A: 0.05, D: 0.4, S: 0.3, R: 0.8, filter: { type: 'lowpass', freq: 1000, Q: 0.8 }, math: 'exponential', lfoRate: 0.1, modDepth: 2.0 }, // Bell-achtige EP
    { name: 'Harpsichord (7)', wave: 'square', A: 0.005, D: 0.1, S: 0.0, R: 0.3, filter: { type: 'lowpass', freq: 5000, Q: 0.1 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Clavichord (8)', wave: 'triangle', A: 0.01, D: 0.15, S: 0.0, R: 0.2, filter: { type: 'lowpass', freq: 1000, Q: 0.1 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },

    // ----------------------------------------------------------------------
    // 09-16: CHROMATIC PERCUSSION
    // ----------------------------------------------------------------------
    { name: 'Celesta (9)', wave: 'sine', A: 0.01, D: 0.3, S: 0.0, R: 0.5, filter: null, math: 'exponential', lfoRate: 0.0, modDepth: 0.0, isFM: true },
    { name: 'Glockenspiel (10)', wave: 'sine', A: 0.005, D: 0.2, S: 0.0, R: 0.4, filter: { type: 'highpass', freq: 5000, Q: 0.1 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0, isFM: true },
    { name: 'Music Box (11)', wave: 'triangle', A: 0.01, D: 0.4, S: 0.0, R: 0.6, filter: { type: 'lowpass', freq: 5000, Q: 0.2 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Vibraphone (12)', wave: 'sine', A: 0.05, D: 0.8, S: 0.0, R: 1.0, filter: { type: 'lowpass', freq: 4000, Q: 0.5 }, math: 'exponential', lfoRate: 3.0, modDepth: 0.5 }, // Tremolo/Vibrato
    { name: 'Marimba (13)', wave: 'triangle', A: 0.01, D: 0.3, S: 0.0, R: 0.5, filter: { type: 'lowpass', freq: 1500, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Xylophone (14)', wave: 'square', A: 0.005, D: 0.2, S: 0.0, R: 0.3, filter: { type: 'highpass', freq: 2000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Tubular Bells (15)', wave: 'sine', A: 0.1, D: 1.0, S: 0.0, R: 2.0, filter: null, math: 'exponential', lfoRate: 0.0, modDepth: 0.0, isFM: true, modDepth: 200.0 }, // Meer FM-diepte
    { name: 'Dulcimer (16)', wave: 'sawtooth', A: 0.01, D: 0.3, S: 0.0, R: 0.5, filter: { type: 'lowpass', freq: 5000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },

    // ----------------------------------------------------------------------
    // 17-24: ORGAN
    // ----------------------------------------------------------------------
    { name: 'Drawbar Organ (17)', wave: 'sawtooth', A: 0.1, D: 0.1, S: 1.0, R: 0.5, filter: { type: 'lowpass', freq: 8000, Q: 0.1 }, math: 'linear', lfoRate: 5.0, modDepth: 0.2, multiOsc: true }, // Rotary speaker/Chorus
    { name: 'Percussive Organ (18)', wave: 'sawtooth', A: 0.05, D: 0.1, S: 1.0, R: 0.5, filter: { type: 'lowpass', freq: 5000, Q: 0.1 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0, multiOsc: true },
    { name: 'Rock Organ (19)', wave: 'square', A: 0.05, D: 0.1, S: 1.0, R: 0.5, filter: { type: 'lowpass', freq: 10000, Q: 0.1 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0},
    { name: 'Church Organ (20)', wave: 'sine', A: 0.5, D: 0.5, S: 1.0, R: 1.0, filter: { type: 'lowpass', freq: 2000, Q: 0.1 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0, multiOsc: true },
    { name: 'Reed Organ (21)', wave: 'triangle', A: 0.1, D: 0.5, S: 0.9, R: 0.6, filter: { type: 'lowpass', freq: 800, Q: 1.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Accordion (22)', wave: 'sawtooth', A: 0.1, D: 0.2, S: 0.9, R: 0.5, filter: { type: 'lowpass', freq: 1000, Q: 1.0 }, math: 'linear', lfoRate: 3.0, modDepth: 0.2 }, // Balgmodulatie
    { name: 'Harmonica (23)', wave: 'square', A: 0.1, D: 0.3, S: 0.9, R: 0.4, filter: { type: 'bandpass', freq: 1500, Q: 2.0 }, math: 'linear', lfoRate: 0.5, modDepth: 1.0 },
    { name: 'Tango Accordion (24)', wave: 'triangle', A: 0.1, D: 0.2, S: 0.9, R: 0.5, filter: { type: 'lowpass', freq: 800, Q: 1.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },

    // ----------------------------------------------------------------------
    // 25-32: GUITAR
    // ----------------------------------------------------------------------
    { name: 'Acoustic Guitar (nylon) (25)', wave: 'triangle', A: 0.005, D: 0.5, S: 0.0, R: 0.5, filter: { type: 'lowpass', freq: 4000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Acoustic Guitar (steel) (26)', wave: 'sawtooth', A: 0.005, D: 0.4, S: 0.0, R: 0.4, filter: { type: 'lowpass', freq: 6000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Electric Guitar (jazz) (27)', wave: 'sine', A: 0.05, D: 0.5, S: 0.5, R: 0.6, filter: { type: 'lowpass', freq: 2000, Q: 0.8 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Electric Guitar (clean) (28)', wave: 'sawtooth', A: 0.01, D: 0.4, S: 0.4, R: 0.5, filter: { type: 'lowpass', freq: 4000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Electric Guitar (muted) (29)', wave: 'square', A: 0.005, D: 0.05, S: 0.0, R: 0.1, filter: { type: 'lowpass', freq: 800, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Overdriven Guitar (30)', wave: 'sawtooth', A: 0.01, D: 0.3, S: 0.6, R: 0.5, filter: { type: 'lowpass', freq: 1000, Q: 2.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Distorted Guitar (31)', wave: 'square', A: 0.01, D: 0.3, S: 0.7, R: 0.5, filter: { type: 'lowpass', freq: 800, Q: 3.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Guitar Harmonics (32)', wave: 'sine', A: 0.01, D: 0.4, S: 0.0, R: 0.5, filter: { type: 'highpass', freq: 4000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },

    // ----------------------------------------------------------------------
    // 33-40: BASS
    // ----------------------------------------------------------------------
    { name: 'Acoustic Bass (33)', wave: 'triangle', A: 0.05, D: 0.4, S: 0.0, R: 0.5, filter: { type: 'lowpass', freq: 300, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Electric Bass (finger) (34)', wave: 'sawtooth', A: 0.05, D: 0.3, S: 0.5, R: 0.4, filter: { type: 'lowpass', freq: 500, Q: 0.8 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Electric Bass (pick) (35)', wave: 'square', A: 0.01, D: 0.2, S: 0.4, R: 0.3, filter: { type: 'lowpass', freq: 800, Q: 1.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Fretless Bass (36)', wave: 'sine', A: 0.1, D: 0.5, S: 0.8, R: 0.6, filter: { type: 'lowpass', freq: 300, Q: 0.5 }, math: 'exponential', lfoRate: 5.0, modDepth: 0.1 }, // Lichte pitch modulatie (vibrato)
    { name: 'Slap Bass 1 (37)', wave: 'square', A: 0.005, D: 0.1, S: 0.0, R: 0.2, filter: { type: 'bandpass', freq: 1500, Q: 2.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Slap Bass 2 (38)', wave: 'sawtooth', A: 0.005, D: 0.1, S: 0.0, R: 0.2, filter: { type: 'highpass', freq: 800, Q: 1.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Synth Bass 1 (39)', wave: 'square', A: 0.01, D: 0.2, S: 0.7, R: 0.4, filter: { type: 'lowpass', freq: 200, Q: 5.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 }, // Sub bass
    { name: 'Synth Bass 2 (40)', wave: 'sawtooth', A: 0.05, D: 0.3, S: 0.5, R: 0.5, filter: { type: 'lowpass', freq: 500, Q: 1.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },

    // ----------------------------------------------------------------------
    // 41-48: STRING
    // ----------------------------------------------------------------------
    { name: 'Violin (41)', wave: 'sawtooth', A: 0.3, D: 0.8, S: 0.9, R: 0.5, filter: { type: 'lowpass', freq: 3500, Q: 0.5 }, math: 'linear', lfoRate: 6.0, modDepth: 0.5 }, // Vibrato
    { name: 'Viola (42)', wave: 'sawtooth', A: 0.3, D: 0.8, S: 0.9, R: 0.5, filter: { type: 'lowpass', freq: 3000, Q: 0.5 }, math: 'linear', lfoRate: 5.0, modDepth: 0.4 }, // Lagere filter en minder vibrato
    { name: 'Cello (43)', wave: 'sawtooth', A: 0.3, D: 0.8, S: 0.9, R: 0.5, filter: { type: 'lowpass', freq: 2000, Q: 0.5 }, math: 'linear', lfoRate: 4.0, modDepth: 0.3 }, // Lagere filter en minder vibrato
    { name: 'Contrabass (44)', wave: 'sawtooth', A: 0.2, D: 0.5, S: 0.8, R: 0.5, filter: { type: 'lowpass', freq: 1000, Q: 0.5 }, math: 'linear', lfoRate: 3.0, modDepth: 0.2 }, // Nog lagere filter
    { name: 'Tremolo Strings (45)', wave: 'sawtooth', A: 0.1, D: 0.1, S: 1.0, R: 0.5, filter: { type: 'lowpass', freq: 4000, Q: 0.5 }, math: 'linear', lfoRate: 8.0, modDepth: 0.5, volumeGate: true }, // Snelle volume modulatie
    { name: 'Pizzicato Strings (46)', wave: 'triangle', A: 0.005, D: 0.1, S: 0.0, R: 0.3, filter: { type: 'lowpass', freq: 5000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Orchestral Strings (47)', wave: 'sawtooth', A: 0.3, D: 0.8, S: 0.9, R: 1.0, filter: { type: 'lowpass', freq: 3000, Q: 0.5 }, math: 'linear', lfoRate: 0.5, modDepth: 0.1, multiOsc: true }, // Dikkere klank
    { name: 'Timpani (48)', wave: 'sine', A: 0.05, D: 0.5, S: 0.0, R: 1.0, filter: { type: 'lowpass', freq: 200, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0, isFM: true },

    // ----------------------------------------------------------------------
    // 49-56: ENSEMBLE
    // ----------------------------------------------------------------------
    { name: 'String Ensemble 1 (49)', wave: 'sawtooth', A: 0.3, D: 0.8, S: 0.9, R: 1.0, filter: { type: 'lowpass', freq: 4000, Q: 0.5 }, math: 'linear', lfoRate: 0.2, modDepth: 0.5, multiOsc: true },
    { name: 'String Ensemble 2 (50)', wave: 'sawtooth', A: 0.3, D: 0.8, S: 0.9, R: 1.0, filter: { type: 'lowpass', freq: 3000, Q: 0.8 }, math: 'linear', lfoRate: 0.5, modDepth: 0.8, multiOsc: true },
    { name: 'Synth Strings 1 (51)', wave: 'sawtooth', A: 0.1, D: 0.5, S: 0.8, R: 0.8, filter: { type: 'lowpass', freq: 5000, Q: 1.0 }, math: 'linear', lfoRate: 0.5, modDepth: 5.0 },
    { name: 'Synth Strings 2 (52)', wave: 'sawtooth', A: 0.1, D: 0.5, S: 0.8, R: 0.8, filter: { type: 'lowpass', freq: 3000, Q: 1.5 }, math: 'linear', lfoRate: 1.0, modDepth: 8.0 },
    { name: 'Choir Aahs (53)', wave: 'triangle', A: 0.5, D: 1.0, S: 0.9, R: 1.5, filter: { type: 'bandpass', freq: 800, Q: 2.0 }, math: 'linear', lfoRate: 0.2, modDepth: 0.5, multiOsc: true }, // Vocale vorm
    { name: 'Voice Oohs (54)', wave: 'sine', A: 0.5, D: 1.0, S: 0.9, R: 1.5, filter: { type: 'lowpass', freq: 500, Q: 0.5 }, math: 'linear', lfoRate: 0.2, modDepth: 0.5 },
    { name: 'Synth Voice (55)', wave: 'sawtooth', A: 0.2, D: 0.5, S: 0.8, R: 1.0, filter: { type: 'bandpass', freq: 1000, Q: 3.0 }, math: 'linear', lfoRate: 0.5, modDepth: 10.0 },
    { name: 'Orchestra Hit (56)', wave: 'sawtooth', A: 0.01, D: 0.5, S: 0.0, R: 0.5, filter: { type: 'lowpass', freq: 10000, Q: 0.1 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },

    // ----------------------------------------------------------------------
    // 57-64: BRASS
    // ----------------------------------------------------------------------
    { name: 'Trumpet (57)', wave: 'sawtooth', A: 0.1, D: 0.3, S: 0.7, R: 0.5, filter: { type: 'bandpass', freq: 2500, Q: 3.0 }, math: 'exponential', lfoRate: 5.0, modDepth: 0.5 }, // Sterke resonantie
    { name: 'Trombone (58)', wave: 'sawtooth', A: 0.1, D: 0.3, S: 0.7, R: 0.5, filter: { type: 'bandpass', freq: 1500, Q: 2.0 }, math: 'exponential', lfoRate: 4.0, modDepth: 0.4 },
    { name: 'Tuba (59)', wave: 'sawtooth', A: 0.1, D: 0.3, S: 0.7, R: 0.5, filter: { type: 'lowpass', freq: 800, Q: 1.0 }, math: 'exponential', lfoRate: 3.0, modDepth: 0.3 },
    { name: 'Muted Trumpet (60)', wave: 'square', A: 0.05, D: 0.2, S: 0.6, R: 0.4, filter: { type: 'lowpass', freq: 1000, Q: 2.0 }, math: 'exponential', lfoRate: 5.0, modDepth: 0.5 },
    { name: 'French Horn (61)', wave: 'sine', A: 0.2, D: 0.5, S: 0.8, R: 0.6, filter: { type: 'lowpass', freq: 1500, Q: 0.5 }, math: 'linear', lfoRate: 0.5, modDepth: 0.1 },
    { name: 'Brass Section (62)', wave: 'sawtooth', A: 0.2, D: 0.5, S: 0.8, R: 0.6, filter: { type: 'lowpass', freq: 2000, Q: 0.8 }, math: 'linear', lfoRate: 0.5, modDepth: 0.5, multiOsc: true },
    { name: 'Synth Brass 1 (63)', wave: 'sawtooth', A: 0.05, D: 0.1, S: 0.7, R: 0.5, filter: { type: 'lowpass', freq: 4000, Q: 2.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0, filterMod: true }, // Envelope op filter
    { name: 'Synth Brass 2 (64)', wave: 'square', A: 0.05, D: 0.1, S: 0.6, R: 0.4, filter: { type: 'lowpass', freq: 2000, Q: 3.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0, filterMod: true },

    // ----------------------------------------------------------------------
    // 65-72: REED
    // ----------------------------------------------------------------------
    { name: 'Soprano Sax (65)', wave: 'sawtooth', A: 0.1, D: 0.3, S: 0.8, R: 0.5, filter: { type: 'bandpass', freq: 3000, Q: 1.0 }, math: 'linear', lfoRate: 5.0, modDepth: 0.5 },
    { name: 'Alto Sax (66)', wave: 'sawtooth', A: 0.1, D: 0.3, S: 0.8, R: 0.5, filter: { type: 'bandpass', freq: 2000, Q: 1.0 }, math: 'linear', lfoRate: 5.0, modDepth: 0.5 },
    { name: 'Tenor Sax (67)', wave: 'sawtooth', A: 0.1, D: 0.3, S: 0.8, R: 0.5, filter: { type: 'bandpass', freq: 1500, Q: 1.0 }, math: 'linear', lfoRate: 5.0, modDepth: 0.5 },
    { name: 'Baritone Sax (68)', wave: 'sawtooth', A: 0.1, D: 0.3, S: 0.8, R: 0.5, filter: { type: 'bandpass', freq: 1000, Q: 1.0 }, math: 'linear', lfoRate: 5.0, modDepth: 0.5 },
    { name: 'Oboe (69)', wave: 'triangle', A: 0.1, D: 0.5, S: 0.9, R: 0.4, filter: { type: 'lowpass', freq: 1500, Q: 1.0 }, math: 'logarithmic', lfoRate: 5.0, modDepth: 0.5 },
    { name: 'English Horn (70)', wave: 'triangle', A: 0.1, D: 0.5, S: 0.9, R: 0.4, filter: { type: 'lowpass', freq: 1000, Q: 1.0 }, math: 'logarithmic', lfoRate: 5.0, modDepth: 0.5 },
    { name: 'Bassoon (71)', wave: 'triangle', A: 0.1, D: 0.5, S: 0.9, R: 0.4, filter: { type: 'lowpass', freq: 500, Q: 1.0 }, math: 'logarithmic', lfoRate: 5.0, modDepth: 0.5 },
    { name: 'Clarinet (72)', wave: 'square', A: 0.1, D: 0.4, S: 0.8, R: 0.5, filter: { type: 'lowpass', freq: 1000, Q: 1.0 }, math: 'linear', lfoRate: 5.0, modDepth: 0.5 },

    // ----------------------------------------------------------------------
    // 73-80: PIPE
    // ----------------------------------------------------------------------
    { name: 'Piccolo (73)', wave: 'sine', A: 0.05, D: 0.3, S: 0.9, R: 0.5, filter: { type: 'highpass', freq: 5000, Q: 0.5 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Flute (74)', wave: 'triangle', A: 0.1, D: 0.4, S: 0.9, R: 0.6, filter: { type: 'lowpass', freq: 3000, Q: 0.5 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Recorder (75)', wave: 'triangle', A: 0.05, D: 0.3, S: 0.9, R: 0.5, filter: { type: 'lowpass', freq: 1500, Q: 0.5 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Pan Flute (76)', wave: 'triangle', A: 0.1, D: 0.4, S: 0.8, R: 0.6, filter: { type: 'lowpass', freq: 2000, Q: 1.0 }, math: 'linear', lfoRate: 3.0, modDepth: 0.5 }, // Lichte Pitch modulatie
    { name: 'Blown Bottle (77)', wave: 'sine', A: 0.05, D: 0.3, S: 0.0, R: 0.5, filter: { type: 'lowpass', freq: 800, Q: 1.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Shakuhachi (78)', wave: 'triangle', A: 0.2, D: 0.5, S: 0.8, R: 0.6, filter: { type: 'lowpass', freq: 1000, Q: 1.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Whistle (79)', wave: 'sine', A: 0.01, D: 0.05, S: 0.9, R: 0.2, filter: null, math: 'linear', lfoRate: 10.0, modDepth: 2.0 },
    { name: 'Ocarina (80)', wave: 'triangle', A: 0.1, D: 0.5, S: 0.9, R: 0.6, filter: { type: 'lowpass', freq: 500, Q: 0.5 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },

    // ----------------------------------------------------------------------
    // 81-88: SYNTH LEAD
    // ----------------------------------------------------------------------
    { name: 'Lead 1 (square) (81)', wave: 'square', A: 0.01, D: 0.1, S: 0.7, R: 0.3, filter: { type: 'lowpass', freq: 4000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Lead 2 (sawtooth) (82)', wave: 'sawtooth', A: 0.01, D: 0.1, S: 0.7, R: 0.3, filter: { type: 'lowpass', freq: 4000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Lead 3 (calliope) (83)', wave: 'sine', A: 0.1, D: 0.1, S: 1.0, R: 0.5, filter: { type: 'lowpass', freq: 5000, Q: 0.1 }, math: 'linear', lfoRate: 0.5, modDepth: 1.0, multiOsc: true },
    { name: 'Lead 4 (chiff) (84)', wave: 'triangle', A: 0.05, D: 0.1, S: 0.8, R: 0.4, filter: { type: 'highpass', freq: 1000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Lead 5 (charang) (85)', wave: 'sawtooth', A: 0.01, D: 0.2, S: 0.7, R: 0.5, filter: { type: 'lowpass', freq: 3000, Q: 2.0 }, math: 'exponential', lfoRate: 5.0, modDepth: 10.0 },
    { name: 'Lead 6 (voice) (86)', wave: 'square', A: 0.1, D: 0.2, S: 0.8, R: 0.5, filter: { type: 'bandpass', freq: 800, Q: 3.0 }, math: 'linear', lfoRate: 0.2, modDepth: 5.0 },
    { name: 'Lead 7 (fifths) (87)', wave: 'sawtooth', A: 0.01, D: 0.2, S: 0.7, R: 0.4, filter: { type: 'lowpass', freq: 5000, Q: 0.5 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0, multiOsc: true }, // Extra oscillator op een kwint
    { name: 'Lead 8 (bass + lead) (88)', wave: 'sawtooth', A: 0.01, D: 0.2, S: 0.7, R: 0.5, filter: { type: 'lowpass', freq: 2000, Q: 1.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0, multiOsc: true }, // Extra oscillator op een octaaf

    // ----------------------------------------------------------------------
    // 89-96: SYNTH PAD
    // ----------------------------------------------------------------------
    { name: 'Pad 1 (new age) (89)', wave: 'triangle', A: 1.0, D: 1.0, S: 0.8, R: 2.0, filter: { type: 'lowpass', freq: 5000, Q: 0.5 }, math: 'linear', lfoRate: 0.1, modDepth: 0.5, multiOsc: true },
    { name: 'Pad 2 (warm) (90)', wave: 'sine', A: 2.0, D: 1.0, S: 0.9, R: 3.0, filter: { type: 'lowpass', freq: 1000, Q: 0.8 }, math: 'linear', lfoRate: 0.2, modDepth: 1.0 },
    { name: 'Pad 3 (polysynth) (91)', wave: 'sawtooth', A: 0.5, D: 0.5, S: 0.8, R: 1.0, filter: { type: 'lowpass', freq: 3000, Q: 1.0 }, math: 'linear', lfoRate: 0.5, modDepth: 2.0, multiOsc: true },
    { name: 'Pad 4 (choir) (92)', wave: 'square', A: 1.0, D: 1.0, S: 0.9, R: 2.0, filter: { type: 'bandpass', freq: 800, Q: 3.0 }, math: 'linear', lfoRate: 0.2, modDepth: 1.0 },
    { name: 'Pad 5 (bowed) (93)', wave: 'sawtooth', A: 2.0, D: 2.0, S: 0.8, R: 3.0, filter: { type: 'lowpass', freq: 5000, Q: 0.5 }, math: 'linear', lfoRate: 0.5, modDepth: 3.0 },
    { name: 'Pad 6 (metallic) (94)', wave: 'sine', A: 0.1, D: 0.5, S: 0.7, R: 1.0, filter: { type: 'bandpass', freq: 4000, Q: 5.0 }, math: 'exponential', lfoRate: 0.5, modDepth: 50.0, isFM: true },
    { name: 'Pad 7 (halo) (95)', wave: 'triangle', A: 1.0, D: 1.0, S: 0.9, R: 2.0, filter: { type: 'highpass', freq: 500, Q: 0.5 }, math: 'linear', lfoRate: 0.2, modDepth: 0.5, multiOsc: true },
    { name: 'Pad 8 (sweep) (96)', wave: 'sawtooth', A: 0.5, D: 0.5, S: 0.8, R: 1.0, filter: { type: 'lowpass', freq: 100, Q: 1.0 }, math: 'linear', lfoRate: 0.2, modDepth: 3000.0, filterMod: true }, // Filter Sweep modulatie

    // ----------------------------------------------------------------------
    // 97-104: SYNTH FX
    // ----------------------------------------------------------------------
    { name: 'FX 1 (rain) (97)', wave: 'noise', A: 0.01, D: 1.0, S: 0.0, R: 2.0, filter: { type: 'lowpass', freq: 5000, Q: 0.1 }, math: 'linear', lfoRate: 0.5, modDepth: 0.5 },
    { name: 'FX 2 (soundtrack) (98)', wave: 'sawtooth', A: 0.5, D: 1.0, S: 0.8, R: 3.0, filter: { type: 'lowpass', freq: 200, Q: 0.5 }, math: 'linear', lfoRate: 0.1, modDepth: 1000.0, filterMod: true },
    { name: 'FX 3 (crystal) (99)', wave: 'sine', A: 0.01, D: 0.8, S: 0.0, R: 1.5, filter: { type: 'highpass', freq: 4000, Q: 0.5 }, math: 'exponential', lfoRate: 0.5, modDepth: 1000.0, isFM: true },
    { name: 'FX 4 (atmosphere) (100)', wave: 'triangle', A: 1.0, D: 3.0, S: 0.7, R: 5.0, filter: { type: 'lowpass', freq: 500, Q: 0.5 }, math: 'linear', lfoRate: 0.1, modDepth: 0.2 },
    { name: 'FX 5 (brightness) (101)', wave: 'sawtooth', A: 0.01, D: 0.5, S: 0.8, R: 1.0, filter: { type: 'lowpass', freq: 8000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'FX 6 (goblins) (102)', wave: 'square', A: 0.1, D: 0.5, S: 0.5, R: 1.0, filter: { type: 'bandpass', freq: 200, Q: 5.0 }, math: 'linear', lfoRate: 1.0, modDepth: 50.0, filterMod: true },
    { name: 'FX 7 (echoes) (103)', wave: 'sine', A: 0.01, D: 0.5, S: 0.0, R: 0.8, filter: null, math: 'quadratic', lfoRate: 0.5, modDepth: 50.0, isFM: true },
    { name: 'FX 8 (sci-fi) (104)', wave: 'sawtooth', A: 0.05, D: 0.1, S: 0.5, R: 0.5, filter: { type: 'notch', freq: 1000, Q: 1.0 }, math: 'linear', lfoRate: 10.0, modDepth: 500.0 },

    // ----------------------------------------------------------------------
    // 105-112: ETHNIC
    // ----------------------------------------------------------------------
    { name: 'Sitar (105)', wave: 'sawtooth', A: 0.01, D: 0.5, S: 0.0, R: 0.5, filter: { type: 'lowpass', freq: 5000, Q: 0.5 }, math: 'exponential', lfoRate: 3.0, modDepth: 10.0 },
    { name: 'Banjo (106)', wave: 'square', A: 0.005, D: 0.1, S: 0.0, R: 0.2, filter: { type: 'lowpass', freq: 2000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Shamisen (107)', wave: 'sawtooth', A: 0.005, D: 0.15, S: 0.0, R: 0.3, filter: { type: 'bandpass', freq: 3000, Q: 1.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Koto (108)', wave: 'triangle', A: 0.005, D: 0.5, S: 0.0, R: 0.8, filter: { type: 'lowpass', freq: 4000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Kalimba (109)', wave: 'sine', A: 0.01, D: 0.4, S: 0.0, R: 0.6, filter: { type: 'lowpass', freq: 2000, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0, isFM: true, modDepth: 50.0 },
    { name: 'Bagpipe (110)', wave: 'square', A: 0.2, D: 0.2, S: 1.0, R: 0.5, filter: { type: 'lowpass', freq: 1000, Q: 1.0 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0, multiOsc: true },
    { name: 'Fiddle (111)', wave: 'sawtooth', A: 0.1, D: 0.2, S: 0.9, R: 0.4, filter: { type: 'lowpass', freq: 4000, Q: 0.5 }, math: 'linear', lfoRate: 5.0, modDepth: 0.5 },
    { name: 'Shanai (112)', wave: 'square', A: 0.1, D: 0.3, S: 0.8, R: 0.5, filter: { type: 'bandpass', freq: 1500, Q: 1.0 }, math: 'linear', lfoRate: 8.0, modDepth: 1.0 },

    // ----------------------------------------------------------------------
    // 113-120: PERCUSSIVE
    // ----------------------------------------------------------------------
    { name: 'Tinkle Bell (113)', wave: 'sine', A: 0.005, D: 0.2, S: 0.0, R: 0.5, filter: { type: 'highpass', freq: 5000, Q: 0.1 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0, isFM: true },
    { name: 'Agogo (114)', wave: 'square', A: 0.005, D: 0.1, S: 0.0, R: 0.1, filter: { type: 'bandpass', freq: 2000, Q: 1.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Steel Drums (115)', wave: 'sine', A: 0.05, D: 0.3, S: 0.0, R: 0.5, filter: { type: 'bandpass', freq: 3000, Q: 1.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0, isFM: true },
    { name: 'Woodblock (116)', wave: 'square', A: 0.001, D: 0.05, S: 0.0, R: 0.05, filter: { type: 'bandpass', freq: 800, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Taiko Drum (117)', wave: 'sine', A: 0.1, D: 0.5, S: 0.0, R: 1.0, filter: { type: 'lowpass', freq: 200, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0, isFM: true },
    { name: 'Melodic Tom (118)', wave: 'sine', A: 0.05, D: 0.2, S: 0.0, R: 0.3, filter: { type: 'lowpass', freq: 500, Q: 0.5 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0, isFM: true },
    { name: 'Synth Drum (119)', wave: 'square', A: 0.01, D: 0.1, S: 0.0, R: 0.1, filter: { type: 'lowpass', freq: 1000, Q: 2.0 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Reverse Cymbal (120)', wave: 'noise', A: 0.5, D: 0.1, S: 0.0, R: 1.0, filter: { type: 'highpass', freq: 5000, Q: 0.1 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },

    // ----------------------------------------------------------------------
    // 121-128: SOUND EFFECTS
    // ----------------------------------------------------------------------
    { name: 'Guitar Fret Noise (121)', wave: 'noise', A: 0.001, D: 0.01, S: 0.0, R: 0.05, filter: { type: 'bandpass', freq: 3000, Q: 0.1 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Breath Noise (122)', wave: 'noise', A: 0.01, D: 0.5, S: 0.0, R: 0.5, filter: { type: 'lowpass', freq: 500, Q: 0.1 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Seashore (123)', wave: 'noise', A: 0.1, D: 3.0, S: 0.5, R: 5.0, filter: { type: 'lowpass', freq: 200, Q: 0.1 }, math: 'linear', lfoRate: 0.1, modDepth: 0.1 },
    { name: 'Bird Tweet (124)', wave: 'sine', A: 0.01, D: 0.1, S: 0.0, R: 0.3, filter: { type: 'highpass', freq: 6000, Q: 0.5 }, math: 'exponential', lfoRate: 10.0, modDepth: 50.0, isFM: true },
    { name: 'Telephone Ring (125)', wave: 'square', A: 0.1, D: 0.1, S: 1.0, R: 0.5, filter: { type: 'bandpass', freq: 440, Q: 1.0 }, math: 'linear', lfoRate: 1.0, modDepth: 5.0 },
    { name: 'Helicopter (126)', wave: 'square', A: 0.1, D: 0.5, S: 0.8, R: 1.0, filter: { type: 'lowpass', freq: 200, Q: 1.0 }, math: 'linear', lfoRate: 10.0, modDepth: 0.5, volumeGate: true },
    { name: 'Applause (127)', wave: 'noise', A: 0.1, D: 0.5, S: 0.0, R: 1.0, filter: { type: 'bandpass', freq: 1000, Q: 0.1 }, math: 'linear', lfoRate: 0.0, modDepth: 0.0 },
    { name: 'Gunshot (128)', wave: 'noise', A: 0.5, D: 0.05, S: 0.0, R: 0.1, filter: { type: 'bandpass', freq: 500, Q: 0.1 }, math: 'exponential', lfoRate: 0.0, modDepth: 0.0 },
];
        // --- Global Variables ---
        let audioContext = null;
        let isPlaying = false;
        let masterGain = null;
        let delayNode = null;
        let limiter = null;
        let delaySendGain = null;
        let sequenceInterval = null;
        let drumInterval = null;
        let drumTimeout = null;
        let droneSweepInterval = null;
        let tempoChangeTimeout = null;
        let instrumentChangeInterval = null; 
        let noiseBuffer = null;
        let activeInstrumentVoices = []; 
        let activePatchIndices = []; 
        let noteIndex = 0;
        let isSweepingToMax = true;
        let activeOscillators = []; 
        let activeDrumNodes = [];

        // --- Rolling Channel Management Variables ---
        let instrumentStopTimes = new Map(); // Map<patchIndex, stopTimeMs>
        const MIN_CHANGE_TIME_MS = 15000;
        const MAX_CHANGE_TIME_MS = 35000;
        const MAX_SIMULTANEOUS_INSTRUMENTS = 2;
        const MIN_SIMULTANEOUS_INSTRUMENTS = 1;


        // --- Dynamic Change Variables ---
        let currentNotes = [];
        let currentPattern = [];
        let loopCounter = 0;
        let currentLoopMax = 1;
        let echoBlockCounter = 0;
        let noEchoRepeatCount = 0;

        // --- Global Variables ---
        let audioContext = null;
        let isPlaying = false;
        let masterGain = null;
        let delayNode = null;
        let limiter = null;
        let delaySendGain = null;
        let sequenceInterval = null;
        let drumInterval = null;
        let drumTimeout = null;
        let droneSweepInterval = null;
        let tempoChangeTimeout = null;

        // NEW: Verbeterd variabelebeheer
        let noiseBuffer = null; 
        let currentVoice = null; 
        let noteIndex = 0;
        let isSweepingToMax = true;
        let activeOscillators = []; 
        let activeDrumNodes = []; // Tijdelijke nodes voor opruimen 

        // --- Dynamic Change Variables ---
        let currentNotes = [];
        let currentPattern = [];
        let loopCounter = 0;
        let currentLoopMax = 1;
        let echoBlockCounter = 0;
        let noEchoRepeatCount = 0;

        // --- Tempo/Rhythm Variables ---
        let tempoBPM = 80;
        let stepDurationMs = (60 / tempoBPM / 4) * 1000;

        // --- Drum Variables ---
        let currentDrumPattern = [];
        let drumIndex = 0;

        // --- Solfeggio Drone Variables ---
        let drone396 = null;
        let drone417 = null;

        // Solfeggio Constants
        const MIN_SOLFEGGIO_FREQ = 396.0;
        const MAX_SOLFEGGIO_FREQ = 417.0;
        const SWEEP_DURATION = 5.0;
        const maxDroneVolume = 0.007;
        const droneAttackTime = 30.0;

        // Frequencies and Scales
        const allFrequencies = [
            16.35, 17.32, 18.35, 19.45, 20.60, 21.83, 23.12, 24.50, 25.96, 27.50, 29.14, 30.87,
            32.70, 34.65, 36.71, 38.89, 41.20, 43.65, 46.25, 49.00, 51.91, 55.00, 58.27, 61.74,
            65.41, 69.30, 73.42, 77.78, 82.41, 87.31, 92.50, 98.00, 103.83, 110.00, 116.54, 123.47,
            130.81, 138.59, 146.83, 155.56, 164.81, 174.61, 185.00, 196.00, 207.65, 220.00, 233.08, 246.94,
            261.63, 277.18, 293.66, 311.13, 329.63, 349.23, 369.99, 392.00, 415.30, 440.00, 466.16, 493.88,
            523.25, 554.37, 587.33, 622.25, 659.25, 698.46, 739.99, 783.99, 830.61, 880.00, 932.33, 987.77,
            1046.50, 1108.73, 1174.66, 1244.51, 1318.51, 1396.91, 1479.98, 1567.98, 1661.22, 1760.00, 1864.66, 1975.53
        ];
        const scaleIntervals = [0, 3, 7, 10, 12];

        // --- Generator Functions ---

        function generateUniqueScale() {
            const minIndex = 36;
            const maxIndex = allFrequencies.length - 15;
            const rootIndex = Math.floor(Math.random() * (maxIndex - minIndex)) + minIndex;
            const tempScale = [];

            for (let i = 0; i < scaleIntervals.length; i++) {
                let noteIndex = rootIndex + scaleIntervals[i];
                if (allFrequencies[noteIndex]) {
                    tempScale.push(allFrequencies[noteIndex]);
                }
                if (i === 1 || i === 2) {
                    if (allFrequencies[noteIndex + 12]) {
                        tempScale.push(allFrequencies[noteIndex + 12]);
                    }
                }
            }

            let newScale = [...new Set(tempScale)];
            newScale.sort((a, b) => a - b);

            if (newScale.length < 4) {
                return [261.63, 311.13, 392.00, 466.16];
            }

            return newScale.slice(0, 8);
        }

        function generateUniquePattern(scaleLength) {
            const validScaleLength = Math.max(1, scaleLength);
            const baseIndices = Array.from({ length: validScaleLength }, (_, i) => i);

            for (let i = baseIndices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [baseIndices[i], baseIndices[j]] = [baseIndices[j], baseIndices[i]];
            }

            const patternLength = Math.floor(Math.random() * 4) + 8;
            const newPattern = [];
            for (let i = 0; i < patternLength; i++) {
                const randomIndex = Math.floor(Math.random() * baseIndices.length);
                newPattern.push(baseIndices[randomIndex]);
            }

            return newPattern;
        }

        /**
         * Bepaalt de lengte van de volgende arpeggiator loop.
         * Geeft 2, 4 of 6 herhalingen.
         */
        function calculateNextLoopMax() {
            // Random (1, 2 of 3) * 2
            currentLoopMax = (Math.floor(Math.random() * 3) + 1) * 2;
            console.log(`New loop max set to: ${currentLoopMax} repeats.`);
        }

        function changePatternAndKey() {
            currentNotes = generateUniqueScale();
            currentPattern = generateUniquePattern(currentNotes.length);
            calculateNextLoopMax();
        }

        // --- Utility Functions ---

        function setEcho(isOn) {
            if (!delaySendGain) return;
            const time = audioContext.currentTime;
            delaySendGain.gain.cancelScheduledValues(time);
            delaySendGain.gain.setValueAtTime(isOn ? 1.0 : 0.0, time);
        }

        // Nieuwe functie voor opruimen van knooppunten
        function cleanupAudioNode(node) {
            if (node && typeof node.stop === 'function') {
                try { node.stop(); } catch (e) {}
            }
            if (node && typeof node.disconnect === 'function') {
                try { node.disconnect(); } catch (e) {}
            }
        }
        
        // --- Core Audio Setup ---

        // Oorspronkelijke functie herzien om de noiseBuffer te cachen
        function createNoiseBuffer(duration) {
            const sampleRate = audioContext.sampleRate;
            const bufferSize = sampleRate * duration;
            const buffer = audioContext.createBuffer(1, bufferSize, sampleRate);
            const output = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1;
            }
            return buffer;
        }

        function initAudio() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            audioContext.resume();

            tempoBPM = 80;
            stepDurationMs = (60 / tempoBPM / 4) * 1000;

            // Cache de ruisbuffer eenmalig!
            noiseBuffer = createNoiseBuffer(0.1);

            // 1. Limiter Node
            limiter = audioContext.createDynamicsCompressor();
            limiter.threshold.setValueAtTime(-6, audioContext.currentTime);
            limiter.knee.setValueAtTime(0, audioContext.currentTime);
            limiter.ratio.setValueAtTime(20, audioContext.currentTime);
            limiter.attack.setValueAtTime(0.001, audioContext.currentTime);
            limiter.release.setValueAtTime(0.05, audioContext.currentTime);

            // 2. Master Gain
            masterGain = audioContext.createGain();
            masterGain.gain.setValueAtTime(0.6, audioContext.currentTime);

            // 3. Delay/Echo Setup
            delayNode = audioContext.createDelay(2.0);
            delayNode.delayTime.setValueAtTime(0.4, audioContext.currentTime);

            const feedbackGain = audioContext.createGain();
            feedbackGain.gain.setValueAtTime(0.5, audioContext.currentTime);

            delaySendGain = audioContext.createGain();
            delaySendGain.gain.setValueAtTime(1.0, audioContext.currentTime);

            // --- Connections ---
            masterGain.connect(limiter);
            masterGain.connect(delaySendGain);

            delaySendGain.connect(delayNode);
            delayNode.connect(feedbackGain);
            feedbackGain.connect(delayNode);
            delayNode.connect(limiter);

            limiter.connect(audioContext.destination);

            // Initial setup
            changePatternAndKey();
            currentDrumPattern = generateDrumPattern();
        }

        // --- Remaining Core Logic (Synth Voices, Arpeggiator, Tempo, Drums, Drones) ---
        
        // Verbeterd opruimmechanisme: verwijdert en disconnenct na uitfaden
        function cleanupSynthVoice(voice) {
             const fadeOutTime = 0.6; // Even lang als de stop in stopAudio
             const time = audioContext.currentTime;

             voice.stopNode.gain.cancelAndHoldAtTime(time);
             voice.stopNode.gain.linearRampToValueAtTime(0.0, time + fadeOutTime);
             
             // Stop en disconnect na de fade-out
             setTimeout(() => {
                 try {
                    voice.osc.stop();
                    voice.osc.disconnect();
                    voice.lfo.stop();
                    voice.lfo.disconnect();
                    voice.stopNode.disconnect();
                 } catch (e) {
                     console.warn("Error cleaning up synth voice:", e);
                 }
                 const index = activeOscillators.indexOf(voice);
                 if (index > -1) activeOscillators.splice(index, 1);
             }, fadeOutTime * 1000 + 10); // +10ms buffer
        }


        function createSynthVoice(frequency) {
            if (!audioContext) return;
            const time = audioContext.currentTime;

            const osc = audioContext.createOscillator();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(frequency, time);

            const lfo = audioContext.createOscillator();
            lfo.type = 'triangle';
            lfo.frequency.setValueAtTime(4.0, time);
            const lfoGain = audioContext.createGain();
            lfoGain.gain.setValueAtTime(2.0, time);

            const envGain = audioContext.createGain();
            envGain.gain.setValueAtTime(0.0, time);

            envGain.gain.linearRampToValueAtTime(0.7, time + 3.0);

            lfo.connect(lfoGain);
            lfoGain.connect(osc.detune);

            osc.connect(envGain);
            envGain.connect(masterGain);

            lfo.start(time);
            osc.start(time);

            const voice = { osc: osc, stopNode: envGain, lfo: lfo };
            activeOscillators.push(voice);
            
            // Verwijder de oude 60s timeout - cleanup gebeurt nu via `cleanupSynthVoice`
            // De cleanup bij loop change wordt direct in scheduleNote getriggerd
            // Voor het geval dat een stem niet opgeruimd wordt bij de loop start (bijv. in stopAudio)
            // laten we een lange timeout staan, maar roepen we onze cleanup functie aan.
             setTimeout(() => {
                if (activeOscillators.includes(voice)) {
                    cleanupSynthVoice(voice); // Laatste vangnet
                }
            }, 60000); 

            return voice;
        }

        function scheduleNote() {
            if (!isPlaying) return;

            const time = audioContext.currentTime;
            
            // De variabele `noteIndex` is nu een globale variabele, wat zorgt voor 
            // juist beheer en zichtbaarheid van deze staat overal in de code.

            const patternLength = currentPattern.length;
            const isPatternEnd = (noteIndex > 0 && noteIndex % patternLength === 0);

            const patternIndex = currentPattern[noteIndex % patternLength];
            const noteIndexInScale = patternIndex % currentNotes.length;
            const freq = currentNotes[noteIndexInScale];

            // --- Dynamic Structure Logic ---
            if (noteIndex > 0 && isPatternEnd) {

                loopCounter++;

                if (echoBlockCounter === 2 && noEchoRepeatCount > 0) {
                    
                    if (loopCounter >= noEchoRepeatCount) {
                        echoBlockCounter = 0;
                        noEchoRepeatCount = 0;
                        setEcho(true);
                        changePatternAndKey();
                        loopCounter = 0;
                    }
                    
                } else if (loopCounter >= currentLoopMax) {
                    
                    echoBlockCounter++;
                    loopCounter = 0;

                    if (echoBlockCounter === 3) {
                        setEcho(false);
                        noEchoRepeatCount = Math.floor(Math.random() * 2) + 2;
                        // Let op: Bij dit type blok blijft de melodie en key VAST
                    } else {
                        setEcho(true);
                        changePatternAndKey();
                    }
                }
            }
            
            // 1. Re-trigger a full new voice every loop start
            if (isPatternEnd) {
                if (currentVoice) {
                    cleanupSynthVoice(currentVoice); // Gebruik de cleanup functie
                }
                currentVoice = createSynthVoice(currentNotes[currentPattern[0] % currentNotes.length]);
            }
            
            // 2. Continuous Pitch Step
            if (currentVoice && currentVoice.osc) {
                currentVoice.osc.frequency.setValueAtTime(freq, time);
            }

            noteIndex++;
        }

        function scheduleTempoChange() {
            if (!isPlaying) return;

            if (sequenceInterval) clearInterval(sequenceInterval);
            if (drumInterval) clearInterval(drumInterval);

            const changePercent = (Math.random() * 0.05) + 0.10;
            const direction = Math.random() < 0.5 ? 1 : -1;

            let newBPM = tempoBPM * (1 + (direction * changePercent));

            newBPM = Math.min(100, Math.max(60, newBPM));

            tempoBPM = newBPM;
            stepDurationMs = (60 / tempoBPM / 4) * 1000;

            console.log(`Tempo changed to: ${tempoBPM.toFixed(2)} BPM`);

            startArpeggiatorInterval();
            if (drumInterval || drumIndex > 0) {
                startDrumInterval();
            }

            const nextChangeTimeMs = (Math.random() * 60 + 60) * 1000;
            tempoChangeTimeout = setTimeout(scheduleTempoChange, nextChangeTimeMs);
        }

        function startArpeggiatorInterval() {
            if (sequenceInterval) clearInterval(sequenceInterval);
            scheduleNote();
            sequenceInterval = setInterval(scheduleNote, stepDurationMs);
        }

        function startDrumInterval() {
            if (drumInterval) clearInterval(drumInterval);
            drumInterval = setInterval(scheduleDrumStep, stepDurationMs);
        }

        function startArpeggiator() {
            if (!audioContext) return;

            noteIndex = 0;
            const introDurationMs = 44000;
            currentVoice = null;

            // Reset structure state on start
            loopCounter = 0;
            currentLoopMax = (Math.floor(Math.random() * 3) + 1) * 2; // Initial double loop max
            echoBlockCounter = 0;
            noEchoRepeatCount = 0;
            setEcho(true);

            // Start Drones
            if (!drone396) { drone396 = createSolfeggioDrone(MIN_SOLFEGGIO_FREQ); }
            if (!drone417) { drone417 = createSolfeggioDrone(MIN_SOLFEGGIO_FREQ); }

            // Start Sweeps en Tempo
            if (!droneSweepInterval) { isSweepingToMax = true; scheduleDroneSweep(); }
            if (!tempoChangeTimeout) scheduleTempoChange();

            // Start Synth
            startArpeggiatorInterval();
            
            // Start Drums
            if (drumTimeout) clearTimeout(drumTimeout);
            drumTimeout = setTimeout(() => {
                if (isPlaying) {
                    drumIndex = 0;
                    startDrumInterval();
                }
            }, introDurationMs);
        }

        function createSolfeggioDrone(initialFrequency) {
            if (!audioContext) return null;
            const time = audioContext.currentTime;

            const osc = audioContext.createOscillator();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(initialFrequency, time);

            const lfo = audioContext.createOscillator();
            lfo.type = 'sine';
            lfo.frequency.setValueAtTime(0.5 + Math.random() * 0.2, time);
            const lfoGain = audioContext.createGain();
            lfoGain.gain.setValueAtTime(0.2, time);

            const envGain = audioContext.createGain();
            envGain.gain.setValueAtTime(0.0001, time);

            envGain.gain.linearRampToValueAtTime(maxDroneVolume, time + droneAttackTime);

            lfo.connect(lfoGain);
            lfoGain.connect(osc.detune);

            osc.connect(envGain);
            envGain.connect(masterGain);

            lfo.start(time);
            osc.start(time);

            return { osc: osc, stopNode: envGain, lfo: lfo };
        }

        function scheduleDroneSweep() {
            if (!isPlaying || !audioContext) return;
            const time = audioContext.currentTime;

            const targetFreq = isSweepingToMax ? MAX_SOLFEGGIO_FREQ : MIN_SOLFEGGIO_FREQ;
            const isRamp = Math.random() < 0.7;
            const sweepTime = isRamp ? SWEEP_DURATION : 0.001;

            const updateFrequency = (drone) => {
                if (drone && drone.osc) {
                    drone.osc.frequency.cancelScheduledValues(time);
                    if (isRamp) {
                        drone.osc.frequency.linearRampToValueAtTime(targetFreq, time + sweepTime);
                    } else {
                        drone.osc.frequency.setValueAtTime(targetFreq, time);
                    }
                }
            };

            updateFrequency(drone396);
            updateFrequency(drone417);

            isSweepingToMax = !isSweepingToMax;

            const randomWaitTime = Math.random() * 20 + 20;
            const nextChangeTimeMs = (sweepTime + randomWaitTime) * 1000;
            
            if (droneSweepInterval) clearTimeout(droneSweepInterval);
            droneSweepInterval = setTimeout(scheduleDroneSweep, nextChangeTimeMs);
        }

        // Refactored om de gecachte noiseBuffer te gebruiken en op te ruimen
        function createPercussionSound(time, type, volume) {
            if (!audioContext) return;
            const nodesToCleanup = [];
            const drumGain = audioContext.createGain();
            drumGain.gain.setValueAtTime(0.0001, time);
            drumGain.connect(limiter);
            nodesToCleanup.push(drumGain);

            let stopTime = time;

            switch(type) {
                case 'kick': {
                    const osc = audioContext.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(80.0, time);
                    osc.frequency.exponentialRampToValueAtTime(30.0, time + 0.15);
                    osc.connect(drumGain);
                    drumGain.gain.exponentialRampToValueAtTime(volume * 1.5, time + 0.005);
                    drumGain.gain.exponentialRampToValueAtTime(0.0001, time + 0.3);
                    osc.start(time);
                    stopTime = time + 0.3;
                    nodesToCleanup.push(osc);
                    break;
                }
                case 'snare': {
                    const noise = audioContext.createBufferSource();
                    if (!noiseBuffer) return; // Zorg ervoor dat de buffer bestaat
                    noise.buffer = noiseBuffer;
                    noise.loop = true;
                    const bandpass = audioContext.createBiquadFilter();
                    bandpass.type = 'bandpass';
                    bandpass.frequency.setValueAtTime(1500, time);
                    bandpass.Q.setValueAtTime(5, time);
                    noise.connect(bandpass);
                    bandpass.connect(drumGain);
                    drumGain.gain.exponentialRampToValueAtTime(volume * 0.8, time + 0.001);
                    drumGain.gain.exponentialRampToValueAtTime(0.0001, time + 0.1);
                    noise.start(time);
                    stopTime = time + 0.15;
                    nodesToCleanup.push(noise, bandpass);
                    break;
                }
                case 'closedhat': {
                    const noise = audioContext.createBufferSource();
                    if (!noiseBuffer) return;
                    noise.buffer = noiseBuffer;
                    noise.loop = true;
                    const hiPass = audioContext.createBiquadFilter();
                    hiPass.type = 'highpass';
                    hiPass.frequency.setValueAtTime(7000, time);
                    noise.connect(hiPass);
                    hiPass.connect(drumGain);
                    drumGain.gain.exponentialRampToValueAtTime(volume * 0.5, time + 0.001);
                    drumGain.gain.exponentialRampToValueAtTime(0.0001, time + 0.08);
                    noise.start(time);
                    stopTime = time + 0.08;
                    nodesToCleanup.push(noise, hiPass);
                    break;
                }
                case 'openhat': {
                    const noise = audioContext.createBufferSource();
                    if (!noiseBuffer) return;
                    noise.buffer = noiseBuffer;
                    noise.loop = true;
                    const hiPass = audioContext.createBiquadFilter();
                    hiPass.type = 'highpass';
                    hiPass.frequency.setValueAtTime(7000, time);
                    noise.connect(hiPass);
                    hiPass.connect(drumGain);
                    drumGain.gain.exponentialRampToValueAtTime(volume * 0.4, time + 0.001);
                    drumGain.gain.exponentialRampToValueAtTime(0.0001, time + 0.4);
                    noise.start(time);
                    stopTime = time + 0.4;
                    nodesToCleanup.push(noise, hiPass);
                    break;
                }
            }
            
            // Cleanup: Stop en disconnect alle nodes na de looptijd + buffer
            setTimeout(() => {
                nodesToCleanup.forEach(cleanupAudioNode);
            }, (stopTime - time) * 1000 + 10);
        }

        function generateDrumPattern() {
            const patternLength = 16;
            const newPattern = [];

            for (let i = 0; i < patternLength; i++) {
                const step = [0, 0, 0, 0];

                if (i % 4 === 0) {
                    step[0] = 1;
                } else if (i % 2 === 1) {
                    step[0] = Math.random() < 0.15 ? 1 : 0;
                }

                if (i === 4 || i === 12) {
                    step[1] = 1;
                } else if (i % 2 === 1) {
                    step[1] = Math.random() < 0.1 ? 1 : 0;
                }

                if (i % 2 === 1) {
                    step[2] = 1;
                } else if (i % 4 === 0) {
                    step[2] = Math.random() < 0.2 ? 1 : 0;
                }

                if (i % 8 === 3 || i % 8 === 7) {
                    step[3] = Math.random() < 0.4 ? 1 : 0;
                }

                if (step[2] === 1 && step[3] === 1) {
                    step[3] = 0;
                }

                newPattern.push(step);
            }
            return newPattern;
        }

        function scheduleDrumStep() {
            if (!isPlaying || !audioContext) return;
            const time = audioContext.currentTime;
            const step = currentDrumPattern[drumIndex % currentDrumPattern.length];
            const KICK = step[0];
            const SNARE = step[1];
            const CLOSED_HAT = step[2];
            const OPEN_HAT = step[3];

            if (drumIndex > 0 && drumIndex % currentDrumPattern.length === 0) {
                currentDrumPattern = generateDrumPattern();
            }

            if (KICK) createPercussionSound(time, 'kick', 0.8);
            if (SNARE) createPercussionSound(time, 'snare', 0.4);
            if (CLOSED_HAT) createPercussionSound(time, 'closedhat', 0.2);
            if (OPEN_HAT) createPercussionSound(time, 'openhat', 0.3);

            drumIndex++;
        }
        
        // Verbeterde stopAudio voor nettere opruiming
        function stopAudio() {
            if (!audioContext) return;
            isPlaying = false;
            
            // Clear alle Timeouts en Intervals
            clearInterval(sequenceInterval);
            clearInterval(drumInterval);
            clearTimeout(drumTimeout);
            clearTimeout(droneSweepInterval);
            clearTimeout(tempoChangeTimeout);
            
            sequenceInterval = null;
            drumInterval = null;
            drumTimeout = null;
            droneSweepInterval = null;
            tempoChangeTimeout = null;

            // Stop Drones en Synths met fade-out
            const stopTime = audioContext.currentTime + 0.5;

            // Drones opruimen
            [drone396, drone417].forEach(drone => {
                if (drone) {
                    try {
                        drone.stopNode.gain.cancelAndHoldAtTime(audioContext.currentTime);
                        drone.stopNode.gain.linearRampToValueAtTime(0.0, stopTime);
                        
                        setTimeout(() => {
                            cleanupAudioNode(drone.osc);
                            cleanupAudioNode(drone.lfo);
                            drone.stopNode.disconnect();
                        }, 600);
                    } catch (e) {}
                }
            });
            drone396 = null;
            drone417 = null;

            // Synth voices opruimen
            activeOscillators.forEach(voice => {
                try {
                    voice.stopNode.gain.cancelAndHoldAtTime(audioContext.currentTime);
                    voice.stopNode.gain.linearRampToValueAtTime(0.0, stopTime);
                    
                    setTimeout(() => {
                        cleanupAudioNode(voice.osc);
                        cleanupAudioNode(voice.lfo);
                        voice.stopNode.disconnect();
                    }, 600);
                } catch (e) {}
            });
            activeOscillators = [];
            
            // Context suspend
            if (audioContext && audioContext.state === 'running') {
                audioContext.suspend();
            }

            // Reset structure state en tempo
            loopCounter = 0;
            currentLoopMax = 1;
            echoBlockCounter = 0;
            noEchoRepeatCount = 0;
            isSweepingToMax = true;
            tempoBPM = 80;
        }

        // --- Event Listener ---
        document.getElementById('playButton').addEventListener('click', () => {
            if (!audioContext || audioContext.state === 'suspended' || audioContext.state === 'closed') {
                if (!audioContext || audioContext.state === 'closed') {
                    initAudio();
                } else {
                    audioContext.resume();
                }

                isPlaying = true;
                startArpeggiator();

            } else if (audioContext.state === 'running') {
                stopAudio();
            }
        });

    </script>





